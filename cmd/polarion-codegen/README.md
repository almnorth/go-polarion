# polarion-codegen

A CLI tool that leverages the Polarion metadata discovery APIs to auto-generate Go structs for custom work items.

## Overview

`polarion-codegen` automatically generates type-safe Go structs for your Polarion work item types by discovering custom fields through the Polarion REST API. This eliminates manual struct definition and ensures your code stays in sync with your Polarion configuration.

## Features

- **Automatic Discovery**: Discovers work item types and custom fields from Polarion
- **Type-Safe Generation**: Generates Go structs with proper types for each custom field
- **Single or All Types**: Generate for a specific work item type or all types in a project
- **Refresh Mode**: Update existing generated files while preserving custom code
- **Helper Methods**: Generates `LoadFromWorkItem`, `SaveToWorkItem`, and field accessors
- **Generation Markers**: Uses markers to separate generated and custom code sections

## Installation

```bash
go install github.com/almnorth/go-polarion/cmd/polarion-codegen@latest
```

Or build from source:

```bash
cd go-polarion/cmd/polarion-codegen
go build
```

## Usage

### Basic Usage

Generate for a specific work item type:

```bash
polarion-codegen \
  --url https://polarion.example.com/rest/v1 \
  --token YOUR_TOKEN \
  --project myproject \
  --type requirement
```

Generate for all work item types in the project:

```bash
polarion-codegen \
  --url https://polarion.example.com/rest/v1 \
  --token YOUR_TOKEN \
  --project myproject
```

### Command-Line Options

| Option | Description | Required | Default |
|--------|-------------|----------|---------|
| `--url` | Polarion REST API URL | Yes | - |
| `--token` | Authentication token | Yes | - |
| `--project` | Project ID | Yes | - |
| `--type` | Work item type to generate | No | (all types) |
| `--output` | Output directory path | No | `./generated` |
| `--package` | Package name | No | `generated` |
| `--refresh` | Refresh existing files | No | `false` |

### Authentication

The tool requires a Polarion authentication token. You can obtain one from your Polarion instance:

1. Log in to Polarion
2. Go to your user settings
3. Generate a personal access token
4. Use the token with the `--token` flag

For security, consider using environment variables:

```bash
export POLARION_TOKEN="your-token-here"
polarion-codegen --url https://polarion.example.com/rest/v1 --token "$POLARION_TOKEN" --project myproject
```

## Generated Code Structure

### Single Type Mode

When generating for a specific type (e.g., `--type requirement`), the tool creates:

```
generated/
└── requirement.go
```

### All Types Mode

When generating for all types (no `--type` flag), the tool creates:

```
generated/
├── doc.go
├── requirement.go
├── task.go
├── defect.go
└── ...
```

### Generated Struct Example

```go
// Code generated by polarion-codegen. DO NOT EDIT manually between generation markers.
// Source: Polarion project "myproject", work item type "requirement"
// Generated: 2026-01-26T20:00:00Z

package generated

import (
    "fmt"

    polarion "github.com/almnorth/go-polarion"
)

// Requirement represents a custom requirement work item with type-safe field access.
type Requirement struct {
    base *polarion.WorkItem

    // GENERATED_FIELDS_START - Do not edit between markers
    // BusinessValue: Business Value
    // Enumeration: businessValue
    BusinessValue *string

    // TargetRelease: Target Release Date
    TargetRelease *polarion.DateOnly

    // ComplexityPoints: Complexity Points
    ComplexityPoints *float64
    // GENERATED_FIELDS_END

    // Add your custom fields here (they will be preserved during refresh)
}

// NewRequirement creates a new Requirement with initialized base WorkItem.
func NewRequirement(title string) *Requirement {
    return &Requirement{
        base: &polarion.WorkItem{
            Type: "workitems",
            Attributes: &polarion.WorkItemAttributes{
                Title:        title,
                CustomFields: make(map[string]interface{}),
            },
        },
    }
}

// GENERATED_METHODS_START - Do not edit between markers

// LoadFromWorkItem populates the Requirement from a work item.
func (w *Requirement) LoadFromWorkItem(wi *polarion.WorkItem) error {
    w.base = wi

    if wi.Attributes == nil {
        return fmt.Errorf("work item attributes are nil")
    }

    cf := polarion.CustomFields(wi.Attributes.CustomFields)

    if val, ok := cf.GetString("businessValue"); ok {
        w.BusinessValue = &val
    }

    if val, ok := cf.GetDateOnly("targetRelease"); ok {
        w.TargetRelease = &val
    }

    if val, ok := cf.GetFloat("complexityPoints"); ok {
        w.ComplexityPoints = &val
    }

    return nil
}

// SaveToWorkItem saves the Requirement fields back to the work item.
func (w *Requirement) SaveToWorkItem() {
    if w.base == nil || w.base.Attributes == nil {
        return
    }

    if w.base.Attributes.CustomFields == nil {
        w.base.Attributes.CustomFields = make(map[string]interface{})
    }

    cf := polarion.CustomFields(w.base.Attributes.CustomFields)

    if w.BusinessValue != nil {
        cf.Set("businessValue", *w.BusinessValue)
    } else {
        cf.Delete("businessValue")
    }

    if w.TargetRelease != nil {
        cf.Set("targetRelease", w.TargetRelease.String())
    } else {
        cf.Delete("targetRelease")
    }

    if w.ComplexityPoints != nil {
        cf.Set("complexityPoints", *w.ComplexityPoints)
    } else {
        cf.Delete("complexityPoints")
    }
}

// GetBusinessValue returns the Business Value field value.
// Enumeration: businessValue
func (w *Requirement) GetBusinessValue() string {
    if w.BusinessValue != nil {
        return *w.BusinessValue
    }
    return ""
}

// SetBusinessValue sets the Business Value field value.
// Enumeration: businessValue
func (w *Requirement) SetBusinessValue(value string) {
    w.BusinessValue = &value
    if w.base != nil && w.base.Attributes != nil {
        if w.base.Attributes.CustomFields == nil {
            w.base.Attributes.CustomFields = make(map[string]interface{})
        }
        w.base.Attributes.CustomFields["businessValue"] = value
    }
}

// ... (more getters and setters)

// GENERATED_METHODS_END

// GetBase returns the underlying WorkItem for API operations.
func (w *Requirement) GetBase() *polarion.WorkItem {
    return w.base
}

// GetID returns the work item ID.
func (w *Requirement) GetID() string {
    if w.base != nil {
        return w.base.ID
    }
    return ""
}

// GetTitle returns the work item title.
func (w *Requirement) GetTitle() string {
    if w.base != nil && w.base.Attributes != nil {
        return w.base.Attributes.Title
    }
    return ""
}
```

## Using Generated Code

### Creating a New Work Item

```go
package main

import (
    "context"
    "log"
    "time"

    polarion "github.com/almnorth/go-polarion"
    "yourmodule/generated"
)

func main() {
    client, _ := polarion.New("https://polarion.example.com/rest/v1", "token")
    project := client.Project("myproject")
    ctx := context.Background()

    // Create a new requirement
    req := generated.NewRequirement("New Feature Request")
    req.SetBusinessValue("high")
    req.SetTargetRelease(polarion.NewDateOnly(time.Now().AddDate(0, 3, 0)))
    req.SetComplexityPoints(13.0)

    // Save to sync custom fields
    req.SaveToWorkItem()

    // Create in Polarion
    if err := project.WorkItems.Create(ctx, req.GetBase()); err != nil {
        log.Fatal(err)
    }

    log.Printf("Created requirement: %s", req.GetID())
}
```

### Loading an Existing Work Item

```go
// Load work item from Polarion
wi, err := project.WorkItems.Get(ctx, "REQ-123")
if err != nil {
    log.Fatal(err)
}

// Load into typed struct
req := &generated.Requirement{}
if err := req.LoadFromWorkItem(wi); err != nil {
    log.Fatal(err)
}

// Access custom fields with type safety
fmt.Printf("Business Value: %s\n", req.GetBusinessValue())
fmt.Printf("Target Release: %s\n", req.GetTargetRelease().String())
fmt.Printf("Complexity: %.1f\n", req.GetComplexityPoints())
```

### Updating Custom Fields

```go
// Update fields
req.SetBusinessValue("critical")
req.SetComplexityPoints(21.0)

// Save changes
req.SaveToWorkItem()
if err := project.WorkItems.Update(ctx, req.GetBase()); err != nil {
    log.Fatal(err)
}
```

## Refresh Mode

The `--refresh` flag updates existing generated files while preserving custom code:

```bash
polarion-codegen \
  --url https://polarion.example.com/rest/v1 \
  --token YOUR_TOKEN \
  --project myproject \
  --refresh
```

### How Refresh Works

1. **Parses existing files** to find generation markers
2. **Extracts custom code** sections (outside markers)
3. **Generates new code** from current Polarion metadata
4. **Merges code** by replacing marker sections while preserving custom sections
5. **Reports changes** to the user

### Generation Markers

The tool uses markers to separate generated and custom code:

- `GENERATED_FIELDS_START` / `GENERATED_FIELDS_END`: Struct fields
- `GENERATED_METHODS_START` / `GENERATED_METHODS_END`: Generated methods

**Do not edit code between these markers** - it will be overwritten during refresh.

You can safely add custom code:
- After `GENERATED_FIELDS_END` in the struct
- After `GENERATED_METHODS_END` in the file

## Field Type Mapping

The tool maps Polarion field kinds to Go types:

| Polarion Kind | Go Type |
|---------------|---------|
| `string` | `*string` |
| `text`, `text/html` | `*polarion.TextContent` |
| `integer` | `*int` |
| `float` | `*float64` |
| `boolean` | `*bool` |
| `date` | `*polarion.DateOnly` |
| `time` | `*polarion.TimeOnly` |
| `date-time` | `*polarion.DateTime` |
| `duration` | `*polarion.Duration` |
| `enumeration` | `*string` (with comment listing enum name) |
| `relationship` | `*string` (relationship ID) |

All fields are pointer types to distinguish between "not set" and "zero value".

## Requirements

- Go 1.21 or later
- Polarion 2512 or later (for Fields Metadata API)
- Valid Polarion authentication token
- Network access to Polarion REST API

## Troubleshooting

### "Failed to get fields metadata"

- Verify your Polarion version is 2512 or later
- Check that the project ID is correct
- Ensure your token has appropriate permissions

### "Work item type not found"

- Verify the type ID matches exactly (case-sensitive)
- Use `--type` without the flag to see all available types

### "Permission denied"

- Ensure your authentication token is valid
- Check that you have read access to the project
- Verify the token has not expired

## Examples

See the [examples directory](../../examples/custom_workitems/) for complete working examples.

## License

Apache-2.0 - See [LICENSE](../../LICENSE) for details.

## Contributing

Contributions are welcome! Please see [CONTRIBUTING.md](../../CONTRIBUTING.md) for guidelines.
